name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy_render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Placeholder Render deployment steps — keep or replace with your Render steps
      - name: Build and deploy to Render (placeholder)
        run: |
          echo "Add your Render steps here if needed"

  deploy_railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: deploy_render
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo root (debug)
        run: ls -la

      - name: Install Railway CLI
        run: curl -sL https://railway.app/install.sh | sh

      - name: Show Railway version (debug)
        run: railway --version || true

      - name: Ensure RAILWAY_TOKEN is present
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "${RAILWAY_TOKEN:-}" ]; then
            echo "ERROR: RAILWAY_TOKEN secret is NOT set. Please add it in Settings → Secrets and variables → Actions" >&2
            exit 1
          fi
          echo "RAILWAY_TOKEN present (value hidden)"

      - name: Ensure package.json has start/build scripts (if applicable)
        run: |
          if [ -f ".github/scripts/add-start-build-scripts.sh" ]; then
            bash .github/scripts/add-start-build-scripts.sh
            # Stage changed package.json so it can be used in subsequent steps
            if git status --porcelain | grep -q "package.json"; then
              git add package.json || true
              git --no-pager diff --name-only HEAD || true
            fi
          else
            echo "Helper script not found; skipping"
          fi

      - name: Determine project directory
        id: find_proj
        run: |
          set -e
          # Prefer explicit folder if present
          if [ -d "IcutechTestApi" ]; then
            echo "Found explicit directory: IcutechTestApi"
            echo "PROJECT_DIR=IcutechTestApi" >> $GITHUB_ENV
            exit 0
          fi

          # Try to find a folder containing Dockerfile, .csproj, or package.json (search depth 4)
          PROJECT_DIR=$(find . -maxdepth 4 -type f \( -name "Dockerfile" -o -name "*.csproj" -o -name "package.json" \) -printf '%h\n' | sort -u | head -n1 || true)
          
          if [ -z "$PROJECT_DIR" ]; then
            echo "No Dockerfile, .csproj or package.json found in repo (up to depth 4). Listing top-level files for debug:"
            ls -la
            echo "ERROR: Could not auto-detect project directory. If your project folder has a different name or is deeper, update the workflow to set PROJECT_DIR explicitly." >&2
            exit 1
          fi
          
          PROJECT_DIR="${PROJECT_DIR#./}"
          echo "Found project dir: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      - name: Debug show project dir
        run: |
          echo "PROJECT_DIR = ${PROJECT_DIR:-<not set>}"
          ls -la "${PROJECT_DIR}"

      - name: Build project (if Node) and Deploy to Railway (non-interactive)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -e
          cd "$PROJECT_DIR"

          # If package.json exists, attempt npm install and build
          if [ -f package.json ]; then
            echo "Detected package.json — running npm ci and npm run build (if defined)"
            npm ci --omit=dev || npm ci || true
            # Run build only if script exists; npm will error if missing, so check
            if node -e 'try{const p=require("./package.json"); console.log(Boolean(p.scripts && p.scripts.build));}catch(e){console.log(false)}' | grep -q "true"; then
              npm run build
            else
              echo "No build script defined — skipping npm run build"
            fi
          fi

          echo "Running railway up in $(pwd)"
          # railway reads RAILWAY_TOKEN from environment in CI
          railway up
