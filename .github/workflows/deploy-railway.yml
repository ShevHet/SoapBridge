name: Deploy to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show repo root (debug)
        run: |
          echo "Repo root contents:"
          ls -la
          echo "Searching for project files..."
          find . -maxdepth 4 -type f \( -name "Dockerfile" -o -name "*.csproj" -o -name "package.json" \) | head -20
      
      - name: Determine project directory (auto-detect)
        id: find_proj
        run: |
          set -e
          # Prefer explicit folder if exists and contains project files
          if [ -d "IcutechTestApi" ] && [ -f "IcutechTestApi/IcutechTestApi.csproj" ]; then
            echo "Found explicit directory: IcutechTestApi"
            echo "PROJECT_DIR=IcutechTestApi" >> $GITHUB_ENV
            exit 0
          fi
          
          # Otherwise detect by Dockerfile, .csproj or package.json (depth 4)
          PROJECT_DIR=$(find . -maxdepth 4 -type f \( -name "Dockerfile" -o -name "*.csproj" -o -name "package.json" \) -printf '%h\n' | grep -v node_modules | grep -v bin | grep -v obj | sort -u | head -n1 || true)
          
          if [ -z "$PROJECT_DIR" ]; then
            echo "No Dockerfile, .csproj or package.json found (up to depth 4). Listing top-level files:" >&2
            ls -la
            echo "::error::Could not auto-detect project directory. Set PROJECT_DIR manually in the workflow." >&2
            exit 1
          fi
          
          PROJECT_DIR="${PROJECT_DIR#./}"
          echo "Found project dir: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
      
      - name: Debug show project dir
        run: |
          echo "PROJECT_DIR = ${PROJECT_DIR:-<not set>}"
          if [ -d "$PROJECT_DIR" ]; then
            echo "Directory exists. Contents:"
            ls -la "$PROJECT_DIR" | head -20
          else
            echo "::error::Project directory '$PROJECT_DIR' does not exist!"
            exit 1
          fi
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Build project
        run: |
          set -e
          cd "$PROJECT_DIR"
          echo "Building in directory: $(pwd)"
          if [ -f "*.csproj" ] || [ -f "IcutechTestApi.csproj" ]; then
            dotnet restore
            dotnet build --configuration Release
          else
            echo "No .csproj file found in $PROJECT_DIR, skipping build"
          fi
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Login to Railway
        run: railway login --token "$RAILWAY_TOKEN"
      
      - name: Deploy to Railway
        run: |
          set -e
          cd "$PROJECT_DIR"
          echo "Running railway up in $(pwd)"
          railway up --yes --service icutech-test-api

