name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine project directory (auto-detect)
        id: find_proj
        run: |
          set -e
          # Prefer explicit folder if exists and contains project files
          if [ -d "IcutechTestApi" ] && [ -f "IcutechTestApi/IcutechTestApi.csproj" ]; then
            echo "Found explicit directory: IcutechTestApi"
            PROJECT_DIR="IcutechTestApi"
          else
            # Detect by Dockerfile, .csproj or package.json (depth 4)
            # Exclude node_modules, bin, obj directories
            PROJECT_DIR=$(find . -maxdepth 4 -type f \( -name "Dockerfile" -o -name "*.csproj" -o -name "package.json" \) -printf '%h\n' | grep -v node_modules | grep -v bin | grep -v obj | grep -v Tests | sort -u | head -n1 || true)
            
            if [ -z "$PROJECT_DIR" ]; then
              echo "No Dockerfile, .csproj or package.json found (up to depth 4). Listing top-level files:" >&2
              ls -la
              echo "::error::Could not auto-detect project directory. Set PROJECT_DIR manually in the workflow." >&2
              exit 1
            fi
            
            PROJECT_DIR="${PROJECT_DIR#./}"
          fi
          
          echo "Found project dir: $PROJECT_DIR"
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      - name: Install Playwright
        run: |
          cd tests/e2e
          npm install
          npx playwright install --with-deps

      - name: Build API
        run: |
          set -e
          cd "$PROJECT_DIR"
          echo "Building API in directory: $(pwd)"
          if [ -f "*.csproj" ] || [ -f "IcutechTestApi.csproj" ]; then
            dotnet restore
            dotnet build --configuration Release
          else
            echo "No .csproj file found in $PROJECT_DIR, skipping build"
          fi

      - name: Build Frontend
        run: |
          set -e
          cd "$PROJECT_DIR/IcutechTestApi.Tests"
          echo "Building frontend in directory: $(pwd)"
          if [ -f "package.json" ]; then
            npm install
            npm run build:prod
          else
            echo "No package.json found in $PROJECT_DIR/IcutechTestApi.Tests, skipping frontend build"
          fi

      - name: Run E2E tests
        run: |
          cd tests/e2e
          npm test
        env:
          FRONTEND_URL: http://localhost:5030
          API_URL: http://localhost:5030

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 30

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: tests/e2e/test-results/
          retention-days: 7

