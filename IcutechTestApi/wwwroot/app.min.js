const API_BASE_URL=window.location.origin;let currentUserId=null;async function fetchWithRetry(e,t,n=1){for(let s=0;s<=n;s++)try{return await fetch(e,t)}catch(e){if(s===n)throw e;await new Promise(e=>setTimeout(e,1e3*Math.pow(2,s)))}}function checkPasswordStrength(e){if(!e)return{strength:"Слабый",class:"bg-secondary"};let t=0;return e.length>=6&&t++,e.length>=8&&t++,e.length>=12&&t++,/[a-z]/.test(e)&&t++,/[A-Z]/.test(e)&&t++,/\d/.test(e)&&t++,/[!@#$%^&*(),.?":{}|<>]/.test(e)&&t++,t<=2?{strength:"Слабый",class:"bg-danger"}:t<=4?{strength:"Средний",class:"bg-warning"}:t<=5?{strength:"Сильный",class:"bg-info"}:{strength:"Очень сильный",class:"bg-success"}}async function loadProfile(){const e=document.getElementById("profileUserId").value,t=document.getElementById("profileResult");if(e){t.innerHTML='<div class="alert alert-info">Загрузка профиля...</div>';try{const n=await fetchWithRetry(`${API_BASE_URL}/api/userprofile/${e}`),s=await n.json();n.ok&&s.success?(currentUserId=e,document.getElementById("profileEmail").value=s.profile.email||"",document.getElementById("profileFirstName").value=s.profile.firstName||"",document.getElementById("profileLastName").value=s.profile.lastName||"",document.getElementById("profileContent").style.display="block",t.innerHTML=`<div class="alert alert-success">\n                <strong>Профиль загружен</strong><br>\n                Логин: ${s.profile.login}<br>\n                Полное имя: ${s.profile.fullName}<br>\n                Создан: ${new Date(s.profile.createdAt).toLocaleString("ru-RU")}\n            </div>`):t.innerHTML=`<div class="alert alert-danger">\n                <strong>Ошибка!</strong> ${s.message||"Не удалось загрузить профиль"}\n            </div>`}catch(e){t.innerHTML=`<div class="alert alert-danger">\n            <strong>Ошибка сети!</strong> ${e.message}\n        </div>`}}else t.innerHTML='<div class="alert alert-warning">Введите ID пользователя</div>'}async function checkHealth(){const e=document.getElementById("healthResult");e.innerHTML='<div class="alert alert-info">Проверка здоровья API...</div>';try{const t=await fetch(`${API_BASE_URL}/api/health`),n=await t.json();if(t.ok){const t=n.checks.soapService.status,s="healthy"===t?"success":"degraded"===t?"warning":"danger";e.innerHTML=`<div class="alert alert-success">\n                <h5><strong>✓ API Здорово</strong></h5>\n                <hr>\n                <div class="row">\n                    <div class="col-md-6">\n                        <strong>Сервис:</strong> ${n.service}<br>\n                        <strong>Версия:</strong> ${n.version}<br>\n                        <strong>Статус:</strong> <span class="badge bg-success">${n.status}</span>\n                    </div>\n                    <div class="col-md-6">\n                        <strong>API:</strong> <span class="badge bg-success">${n.checks.api.status}</span><br>\n                        <strong>SOAP Сервис:</strong> <span class="badge bg-${s}">${t}</span><br>\n                        <small class="text-muted">${n.checks.soapService.message}</small>\n                    </div>\n                </div>\n                <hr>\n                <small class="text-muted">Проверено: ${new Date(n.timestamp).toLocaleString("ru-RU")}</small>\n            </div>`}else e.innerHTML='<div class="alert alert-danger">\n                <strong>Ошибка!</strong> API недоступен\n            </div>'}catch(t){e.innerHTML=`<div class="alert alert-danger">\n            <strong>Ошибка сети!</strong> ${t.message}\n        </div>`}}document.getElementById("registerPassword")?.addEventListener("input",e=>{const t=e.target.value,n=document.getElementById("passwordStrength");if(n){const{strength:e,class:s}=checkPasswordStrength(t);n.textContent=e,n.className=`badge ${s}`}}),document.getElementById("loginForm")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("loginResult");t.innerHTML='<div class="alert alert-info">Выполняется вход...</div>';const n=document.getElementById("loginUsername").value,s=document.getElementById("loginPassword").value;try{const e=await fetchWithRetry(`${API_BASE_URL}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:n,password:s})}),r=await e.json();e.ok&&r.success?(r.entity&&r.entity.userId&&(currentUserId=r.entity.userId,document.getElementById("profileUserId").value=currentUserId),t.innerHTML=`<div class="alert alert-success">\n                <strong>Успешно!</strong> ${r.message}\n                <pre class="mt-2">${JSON.stringify(r.entity,null,2)}</pre>\n            </div>`):t.innerHTML=`<div class="alert alert-danger">\n                <strong>Ошибка!</strong> ${r.message||"Неверные учетные данные"}\n            </div>`}catch(e){t.innerHTML=`<div class="alert alert-danger">\n            <strong>Ошибка сети!</strong> ${e.message}\n        </div>`}}),document.getElementById("registerForm")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("registerResult");t.innerHTML='<div class="alert alert-info">Выполняется регистрация...</div>';const n=document.getElementById("registerUsername").value,s=document.getElementById("registerPassword").value,r=document.getElementById("registerEmail").value,a=document.getElementById("registerFirstName").value,l=document.getElementById("registerLastName").value;try{const e=await fetchWithRetry(`${API_BASE_URL}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:n,password:s,email:r||null,firstName:a||null,lastName:l||null})}),i=await e.json();e.ok&&i.success?(i.createdCustomerId&&(currentUserId=i.createdCustomerId,document.getElementById("profileUserId").value=currentUserId),t.innerHTML=`<div class="alert alert-success">\n                <strong>Успешно!</strong> ${i.message}\n                ${i.createdCustomerId?`<br><small>ID пользователя: ${i.createdCustomerId}</small>`:""}\n            </div>`):t.innerHTML=`<div class="alert alert-danger">\n                <strong>Ошибка!</strong> ${i.message||"Ошибка регистрации"}\n            </div>`}catch(e){t.innerHTML=`<div class="alert alert-danger">\n            <strong>Ошибка сети!</strong> ${e.message}\n        </div>`}}),document.getElementById("profileForm")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("profileResult");if(!currentUserId)return void(t.innerHTML='<div class="alert alert-warning">Сначала загрузите профиль</div>');t.innerHTML='<div class="alert alert-info">Обновление профиля...</div>';const n=document.getElementById("profileEmail").value,s=document.getElementById("profileFirstName").value,r=document.getElementById("profileLastName").value;try{const e=await fetchWithRetry(`${API_BASE_URL}/api/userprofile/${currentUserId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n||null,firstName:s||null,lastName:r||null})}),a=await e.json();e.ok&&a.success?t.innerHTML=`<div class="alert alert-success">\n                <strong>Успешно!</strong> ${a.message}\n            </div>`:t.innerHTML=`<div class="alert alert-danger">\n                <strong>Ошибка!</strong> ${a.message||"Ошибка обновления профиля"}\n            </div>`}catch(e){t.innerHTML=`<div class="alert alert-danger">\n            <strong>Ошибка сети!</strong> ${e.message}\n        </div>`}}),document.getElementById("changePasswordForm")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("profileResult");if(!currentUserId)return void(t.innerHTML='<div class="alert alert-warning">Сначала загрузите профиль</div>');const n=document.getElementById("currentPassword").value,s=document.getElementById("newPassword").value,r=document.getElementById("confirmPassword").value;if(s===r){t.innerHTML='<div class="alert alert-info">Изменение пароля...</div>';try{const e=await fetchWithRetry(`${API_BASE_URL}/api/userprofile/${currentUserId}/change-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:n,newPassword:s,confirmPassword:r})}),a=await e.json();e.ok&&a.success?(t.innerHTML=`<div class="alert alert-success">\n                <strong>Успешно!</strong> ${a.message}\n            </div>`,document.getElementById("currentPassword").value="",document.getElementById("newPassword").value="",document.getElementById("confirmPassword").value=""):t.innerHTML=`<div class="alert alert-danger">\n                <strong>Ошибка!</strong> ${a.message||"Ошибка изменения пароля"}\n            </div>`}catch(e){t.innerHTML=`<div class="alert alert-danger">\n            <strong>Ошибка сети!</strong> ${e.message}\n        </div>`}}else t.innerHTML='<div class="alert alert-danger">Новый пароль и подтверждение не совпадают</div>'});