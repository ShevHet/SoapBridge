name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show repo root (debug)
        run: |
          echo "Repo root contents:"
          ls -la
          echo "Searching for project files..."
          find . -maxdepth 4 -type f \( -name "Dockerfile" -o -name "*.csproj" -o -name "package.json" \) | head -20
      
      - name: Auto-detect project directory
        id: detect-project
        run: |
          set -e
          # Prefer explicit folder if exists and contains project files
          if [ -d "IcutechTestApi" ] && [ -f "IcutechTestApi/IcutechTestApi.csproj" ]; then
            echo "Found explicit directory: IcutechTestApi"
            PROJECT_DIR="IcutechTestApi"
          else
            # Detect by Dockerfile, .csproj or package.json (depth 4)
            # Exclude node_modules, bin, obj directories
            PROJECT_DIR=$(find . -maxdepth 4 -type f \( -name "Dockerfile" -o -name "*.csproj" -o -name "package.json" \) -printf '%h\n' | grep -v node_modules | grep -v bin | grep -v obj | grep -v Tests | sort -u | head -n1 || true)
            
            if [ -z "$PROJECT_DIR" ]; then
              echo "No Dockerfile, .csproj or package.json found (up to depth 4). Listing top-level files:" >&2
              ls -la
              echo "::error::Could not auto-detect project directory. Set PROJECT_DIR manually in the workflow." >&2
              exit 1
            fi
            
            PROJECT_DIR="${PROJECT_DIR#./}"
          fi
          
          echo "Found project dir: $PROJECT_DIR"
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
      
      - name: Debug show project dir
        run: |
          echo "PROJECT_DIR = ${PROJECT_DIR:-<not set>}"
          if [ -d "$PROJECT_DIR" ]; then
            echo "Directory exists. Contents:"
            ls -la "$PROJECT_DIR" | head -20
          else
            echo "::error::Project directory '$PROJECT_DIR' does not exist!"
            exit 1
          fi
      
      - name: Add start script to package.json if needed
        run: |
          chmod +x .github/scripts/add-start-script.sh
          .github/scripts/add-start-script.sh
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Build project
        run: |
          set -e
          cd "$PROJECT_DIR"
          echo "Building in directory: $(pwd)"
          if [ -f "*.csproj" ] || [ -f "IcutechTestApi.csproj" ]; then
            dotnet restore
            dotnet build --configuration Release
          else
            echo "No .csproj file found in $PROJECT_DIR, skipping build"
          fi
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Debug - Railway CLI version
        run: railway --version
      
      - name: Login to Railway
        run: railway login --token "$RAILWAY_TOKEN"
      
      - name: Debug - Railway status
        run: railway status || echo "Railway status check completed (may fail if not linked)"
      
      - name: Deploy to Railway
        run: |
          set -e
          cd "$PROJECT_DIR"
          echo "Running railway up in $(pwd)"
          railway up --yes
