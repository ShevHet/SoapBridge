name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy_render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Placeholder Render deployment steps — keep or replace with your Render steps
      - name: Build and deploy to Render (placeholder)
        run: |
          echo "Add your Render steps here if needed"

  deploy_railway:
    name: Deploy to Railway (explicit PROJECT_DIR = IcutechTestApi/wwwroot)
    runs-on: ubuntu-latest
    needs: deploy_render
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo root (debug)
        run: |
          echo "Working dir: $(pwd)"
          ls -la

      - name: Install Railway CLI
        run: curl -sL https://railway.app/install.sh | sh

      - name: Show Railway version (debug)
        run: railway --version || true

      - name: Ensure RAILWAY_TOKEN is present
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "${RAILWAY_TOKEN:-}" ]; then
            echo "ERROR: RAILWAY_TOKEN secret is NOT set. Please add it in Settings → Secrets and variables → Actions" >&2
            exit 1
          fi
          echo "RAILWAY_TOKEN present (value hidden)"

      - name: Ensure package.json has start/build scripts (if applicable)
        run: |
          if [ -f ".github/scripts/add-start-build-scripts.sh" ]; then
            bash .github/scripts/add-start-build-scripts.sh
            # If script changed package.json, show diff
            git --no-pager diff --name-only || true
          else
            echo "Helper script not found; skipping"
          fi

      - name: Set PROJECT_DIR explicitly (Variant C)
        run: |
          echo "Setting PROJECT_DIR to IcutechTestApi/wwwroot (explicit variant C)"
          echo "PROJECT_DIR=IcutechTestApi/wwwroot" >> $GITHUB_ENV

      - name: Verify PROJECT_DIR exists
        run: |
          echo "PROJECT_DIR=${PROJECT_DIR:-<not set>}"
          if [ -z "${PROJECT_DIR:-}" ]; then
            echo "ERROR: PROJECT_DIR is not set" >&2
            exit 1
          fi
          if [ ! -d "${PROJECT_DIR}" ]; then
            echo "ERROR: Project directory '${PROJECT_DIR}' does not exist!"
            echo "Listing repository root for debugging:"
            ls -la
            echo ""
            echo "If this folder should exist but is not tracked in git (e.g. only node_modules), ensure you committed the relevant files (package.json, source files) or add a placeholder .gitkeep into the directory."
            exit 1
          fi
          echo "Project directory found: ${PROJECT_DIR}"
          ls -la "${PROJECT_DIR}" || true

      - name: Build project (if Node) and Deploy to Railway (non-interactive)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -e
          cd "$PROJECT_DIR"

          # If package.json exists, attempt npm install and build
          if [ -f package.json ]; then
            echo "Detected package.json — running npm ci and npm run build (if defined)"
            npm ci --omit=dev || npm ci || true

            if node -e 'try{const p=require("./package.json"); console.log(Boolean(p.scripts && (p.scripts["build:prod"]||p.scripts.build)));}catch(e){console.log(false)}' | grep -q "true"; then
              # prefer build:prod if present, else build
              if node -e 'const p=require("./package.json"); console.log(Boolean(p.scripts && p.scripts["build:prod"]));' | grep -q "true"; then
                npm run build:prod
              else
                npm run build
              fi
            else
              echo "No build script defined — skipping npm run build"
            fi
          else
            echo "No package.json found in ${PROJECT_DIR} — skipping npm build steps"
          fi

          echo "Running railway up in $(pwd)"
          # railway reads RAILWAY_TOKEN from environment in CI; DO NOT call railway login --token
          railway up
