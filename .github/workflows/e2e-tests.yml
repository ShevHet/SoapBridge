name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine project directory (auto-detect)
        id: find_proj
        run: |
          set -e
          # Prefer explicit folder if exists and contains project files
          if [ -d "IcutechTestApi" ] && [ -f "IcutechTestApi/IcutechTestApi.csproj" ]; then
            echo "Found explicit directory: IcutechTestApi"
            PROJECT_DIR="IcutechTestApi"
          else
            # First, try to find a .csproj file that is NOT a test project
            # Look for .csproj files excluding Tests directories and test projects
            PROJECT_DIR=$(find . -maxdepth 4 -type f -name "*.csproj" ! -path "*/Tests/*" ! -path "*/bin/*" ! -path "*/obj/*" ! -path "*/node_modules/*" ! -name "*Tests.csproj" -printf '%h\n' | sort -u | head -n1 || true)
            
            # If no .csproj found, try Dockerfile
            if [ -z "$PROJECT_DIR" ]; then
              PROJECT_DIR=$(find . -maxdepth 4 -type f -name "Dockerfile" ! -path "*/Tests/*" ! -path "*/bin/*" ! -path "*/obj/*" ! -path "*/node_modules/*" -printf '%h\n' | sort -u | head -n1 || true)
            fi
            
            if [ -z "$PROJECT_DIR" ]; then
              echo "No .csproj or Dockerfile found (excluding Tests directories). Listing files:" >&2
              find . -maxdepth 2 -type f -name "*.csproj" -o -name "Dockerfile" | head -10
              ls -la
              echo "::error::Could not auto-detect project directory. Set PROJECT_DIR manually in the workflow." >&2
              exit 1
            fi
            
            PROJECT_DIR="${PROJECT_DIR#./}"
            
            # Verify that the directory contains a .csproj file (not just Dockerfile)
            # If PROJECT_DIR is '.' and it doesn't contain a .csproj, try to find IcutechTestApi
            if [ "$PROJECT_DIR" = "." ]; then
              # Check if root contains any .csproj files (excluding Tests)
              CSPROJ_COUNT=$(find . -maxdepth 1 -type f -name "*.csproj" ! -name "*Tests*" 2>/dev/null | wc -l)
              if [ "$CSPROJ_COUNT" -eq 0 ]; then
                echo "Root directory does not contain .csproj, checking for IcutechTestApi directory..."
                if [ -d "IcutechTestApi" ] && [ -f "IcutechTestApi/IcutechTestApi.csproj" ]; then
                  PROJECT_DIR="IcutechTestApi"
                  echo "Using IcutechTestApi directory instead"
                else
                  echo "Warning: Root directory does not contain a .csproj file and IcutechTestApi directory not found"
                fi
              fi
            else
              # For non-root directories, verify .csproj exists
              CSPROJ_COUNT=$(find "$PROJECT_DIR" -maxdepth 1 -type f -name "*.csproj" ! -name "*Tests*" 2>/dev/null | wc -l)
              if [ "$CSPROJ_COUNT" -eq 0 ]; then
                echo "Warning: Directory $PROJECT_DIR does not contain a .csproj file"
                # Try fallback to IcutechTestApi if it exists
                if [ -d "IcutechTestApi" ] && [ -f "IcutechTestApi/IcutechTestApi.csproj" ]; then
                  PROJECT_DIR="IcutechTestApi"
                  echo "Falling back to IcutechTestApi directory"
                fi
              fi
            fi
          fi
          
          # Final check: ensure PROJECT_DIR is not a Tests directory
          if [ "$PROJECT_DIR" = "IcutechTestApi.Tests" ] || echo "$PROJECT_DIR" | grep -q "Tests$"; then
            echo "Warning: PROJECT_DIR is set to a Tests directory: $PROJECT_DIR"
            if [ -d "IcutechTestApi" ] && [ -f "IcutechTestApi/IcutechTestApi.csproj" ]; then
              PROJECT_DIR="IcutechTestApi"
              echo "Correcting to IcutechTestApi directory"
            else
              echo "Error: Cannot find IcutechTestApi directory to use instead of Tests directory"
              exit 1
            fi
          fi
          
          echo "Found project dir: $PROJECT_DIR"
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      - name: Install Playwright
        run: |
          cd tests/e2e
          npm install
          npx playwright install --with-deps

      - name: Build API
        run: |
          set -e
          cd "$PROJECT_DIR"
          echo "Building API in directory: $(pwd)"
          if [ -f "*.csproj" ] || [ -f "IcutechTestApi.csproj" ]; then
            dotnet restore
            dotnet build --configuration Release
          else
            echo "No .csproj file found in $PROJECT_DIR, skipping build"
          fi

      - name: Build Frontend
        run: |
          set -e
          # Determine the API project directory (not Tests)
          if [ "$PROJECT_DIR" = "IcutechTestApi.Tests" ]; then
            # If PROJECT_DIR is Tests, use IcutechTestApi instead
            API_PROJECT_DIR="IcutechTestApi"
          else
            API_PROJECT_DIR="$PROJECT_DIR"
          fi
          
          # Frontend is in wwwroot subdirectory of the API project
          FRONTEND_DIR="$API_PROJECT_DIR/wwwroot"
          
          if [ -d "$FRONTEND_DIR" ]; then
            cd "$FRONTEND_DIR"
            echo "Building frontend in directory: $(pwd)"
            if [ -f "package.json" ]; then
              npm install
              npm run build:prod
            else
              echo "No package.json found in $FRONTEND_DIR, skipping frontend build"
            fi
          else
            echo "Frontend directory $FRONTEND_DIR does not exist, skipping frontend build"
          fi

      - name: Run E2E tests
        run: |
          cd tests/e2e
          npm test
        env:
          FRONTEND_URL: http://localhost:5030
          API_URL: http://localhost:5030
          PROJECT_DIR: ${{ env.PROJECT_DIR }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 30

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: tests/e2e/test-results/
          retention-days: 7

